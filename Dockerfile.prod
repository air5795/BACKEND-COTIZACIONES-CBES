# Dockerfile.prod - Optimizado para producci贸n
FROM node:21-alpine3.19

RUN apk add --no-cache \
    libreoffice \
    libstdc++ \
    ttf-dejavu \
    fontconfig \
    && apk add --no-cache --virtual .build-deps bash \
    && rm -rf /var/cache/apk/*

WORKDIR /usr/src/app

# Crear carpetas necesarias
RUN mkdir -p /usr/src/app/pagos-aportes/pagos && \
    chown -R node:node /usr/src/app/pagos-aportes/pagos

# Copiar solo package.json y lock para instalar dependencias
COPY package*.json ./

# Instalar solo dependencias de producci贸n
RUN npm install --omit=dev

# Copiar el build final y recursos
COPY dist ./dist
COPY reports ./reports
COPY recursos ./recursos

ENV PATH="/usr/lib/libreoffice/program:${PATH}"

# Exponer puerto de producci贸n
EXPOSE 4001

# Comando de ejecuci贸n
CMD ["node", "dist/main.js"]